rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Returns true if the signed-in user has an active subscription in Firestore.
    // A user is considered subscribed when their entitlements doc has a non-empty
    // `plan` field OR a non-empty `activePackIds` array.
    function isSubscribed() {
      let ent = firestore.get(/databases/(default)/documents/entitlements/$(request.auth.uid)).data;
      return (ent.keys().hasAny(['plan']) && ent.plan != null && ent.plan != '')
          || (ent.keys().hasAny(['activePackIds']) && ent.activePackIds.size() > 0);
    }

    // quiz-media uploads: only subscribed users can write; anyone can read
    match /quiz-media/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null
                   && isSubscribed()
                   && request.resource.size < 20 * 1024 * 1024; // 20 MB limit
    }
  }
}
